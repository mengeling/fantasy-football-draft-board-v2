# Fantasy Football Draft Board - Automated Deployment Guide

This guide provides complete instructions for deploying the Fantasy Football Draft Board application using our automated deployment pipeline with Docker, Nix, GitHub Actions, and Terraform.

## üöÄ One-Button Deployment

### Quick Start

1. **Run the setup assistant:**
   ```bash
   ./deploy/scripts/setup-secrets.sh
   ```

2. **Configure GitHub secrets and variables** (shown by the setup assistant)

3. **Deploy via GitHub Actions:**
   - Go to the Actions tab in your GitHub repository
   - Find the "Deploy" workflow
   - Click "Run workflow"
   - Choose environment and branch
   - Click "Run workflow" button

That's it! Your application will be automatically deployed to AWS EC2.

## üìã Prerequisites

### Required Tools
- AWS CLI v2
- Terraform >= 1.0
- Docker & Docker Compose
- Git
- SSH client
- Nix (optional, for reproducible builds)

### AWS Requirements
- AWS account with programmatic access
- IAM user with the following permissions:
  - EC2 (full access)
  - VPC (full access)
  - IAM (full access)
  - Route53 (full access, if using custom domain)

## üîß Setup Instructions

### 1. Initial Setup

Run the interactive setup assistant:
```bash
./deploy/scripts/setup-secrets.sh
```

This will guide you through:
- Generating SSH keys
- Configuring AWS credentials
- Setting up GitHub secrets
- Creating deployment configuration

### 2. GitHub Configuration

#### Repository Secrets
Go to: **Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí Repository secrets**

Add these secrets:
- `AWS_ACCESS_KEY_ID`: Your AWS access key ID
- `AWS_SECRET_ACCESS_KEY`: Your AWS secret access key
- `SSH_PUBLIC_KEY`: Your SSH public key (generated by setup script)
- `SSH_PRIVATE_KEY`: Your SSH private key (generated by setup script)

#### Repository Variables
Go to: **Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí Repository variables**

Add these variables:
- `AWS_REGION`: AWS region (e.g., "us-east-1")
- `DOMAIN_NAME`: Your domain name (optional)
- `ROUTE53_ZONE_ID`: Route53 hosted zone ID (optional)

### 3. Local Configuration

For manual deployments, set environment variables:
```bash
export SSH_PUBLIC_KEY="your-public-key-here"
export AWS_REGION="us-east-1"
export DOMAIN_NAME="your-domain.com"  # Optional
export ROUTE53_ZONE_ID="Z1234567890ABC"  # Optional
```

## üéØ Deployment Methods

### Method 1: GitHub Actions (Recommended)

1. **Navigate to GitHub Actions:**
   - Go to your repository
   - Click the "Actions" tab
   - Find the "Deploy" workflow

2. **Run the workflow:**
   - Click "Run workflow"
   - Select environment: `production` or `staging`
   - Choose git branch: `main` or feature branch
   - Optionally force recreate infrastructure
   - Click "Run workflow"

3. **Monitor deployment:**
   - Watch the workflow progress
   - Check logs for any issues
   - Get deployment summary when complete

### Method 2: Manual Deployment

```bash
# Basic deployment
./deploy/scripts/deploy.sh

# Deploy specific branch to staging
./deploy/scripts/deploy.sh -e staging -b develop

# Force recreate infrastructure
./deploy/scripts/deploy.sh -f

# Deploy application only (skip infrastructure)
./deploy/scripts/deploy.sh -s

# Full options
./deploy/scripts/deploy.sh -e production -b main -f -r us-west-2
```

### Method 3: Local Development

```bash
# Using Nix (recommended for reproducible builds)
nix develop
docker-compose up

# Or using Docker directly
docker-compose up
```

## üèóÔ∏è Infrastructure Overview

### Architecture

```
[Users] ‚Üí [Load Balancer] ‚Üí [EC2 Instance] ‚Üí [Docker Containers]
                                              ‚îú‚îÄ‚îÄ Frontend (Nginx)
                                              ‚îú‚îÄ‚îÄ Backend (Rust/Actix)
                                              ‚îú‚îÄ‚îÄ Database (PostgreSQL)
                                              ‚îî‚îÄ‚îÄ Cron (Data Updates)
```

### AWS Resources Created

- **VPC**: Custom VPC with public subnet
- **EC2 Instance**: t3.medium (configurable)
- **Security Group**: HTTP/HTTPS/SSH access
- **Elastic IP**: Static IP address
- **Route53 Record**: DNS (if domain configured)
- **EBS Volume**: Encrypted root volume

### Container Services

- **Frontend**: SvelteKit app served by Nginx
- **Backend**: Rust/Actix web server
- **Database**: PostgreSQL 16
- **Cron**: Automated data updates

## üîí Security Features

### Network Security
- Security groups with minimal required ports
- Fail2ban for intrusion detection
- Rate limiting on API endpoints
- Security headers (HSTS, CSP, etc.)

### Application Security
- Container isolation with Docker
- Non-root user execution
- Encrypted EBS volumes
- SSH key-based authentication only

### Monitoring & Logging
- Application health checks
- Log rotation and retention
- Prometheus metrics export
- CloudWatch integration (optional)

## üìä Monitoring & Maintenance

### Health Checks
- Application health endpoint: `/health`
- Automated monitoring every 5 minutes
- Container health checks in Docker Compose

### Logging
- Application logs: `/home/ubuntu/app/logs/`
- System logs: `journalctl -u ffball`
- Nginx logs: `/var/log/nginx/`

### Backup & Recovery
- Daily database backups using BorgBackup
- Application code in Git repository
- Infrastructure as code with Terraform

### Maintenance Commands

```bash
# SSH into the server
ssh ubuntu@<public-ip>

# Check application status
docker-compose ps

# View logs
docker-compose logs -f

# Restart services
docker-compose restart

# Update application
cd /home/ubuntu/app
git pull origin main
docker-compose up -d --build

# Check system health
sudo systemctl status ffball
```

## üõ†Ô∏è Troubleshooting

### Common Issues

1. **Deployment fails at infrastructure stage:**
   - Check AWS credentials and permissions
   - Verify Terraform configuration
   - Ensure SSH key is properly configured

2. **Application doesn't start:**
   - Check container logs: `docker-compose logs`
   - Verify database connection
   - Check system resources

3. **Database connection issues:**
   - Ensure PostgreSQL is running: `sudo systemctl status postgresql`
   - Check database credentials
   - Verify network connectivity

4. **SSL/Domain issues:**
   - Verify Route53 configuration
   - Check domain DNS settings
   - Ensure SSL certificates are valid

### Debug Commands

```bash
# Check infrastructure status
cd deploy/terraform
terraform show

# Verify EC2 instance
aws ec2 describe-instances

# Check application health
curl -f http://your-domain.com/health

# Debug containers
docker-compose ps
docker-compose logs backend
docker-compose logs frontend

# System diagnostics
sudo systemctl status ffball
sudo journalctl -u ffball -f
```

## üîÑ CI/CD Pipeline

### Continuous Integration
- **Code Quality**: Rust formatting and linting
- **Testing**: Unit and integration tests
- **Security**: Dependency auditing
- **Build**: Docker image creation

### Continuous Deployment
- **Infrastructure**: Terraform provisioning
- **Application**: Docker container deployment
- **Health Checks**: Automated verification
- **Rollback**: Automatic on failure

### Workflow Triggers
- **Push to main**: Automatic CI build
- **Manual dispatch**: One-button deployment
- **Pull requests**: CI validation
- **Scheduled**: Nightly security scans

## üìà Performance Optimization

### Application Performance
- **Caching**: Nginx static asset caching
- **Compression**: Gzip compression enabled
- **Database**: Optimized PostgreSQL configuration
- **CDN**: CloudFront integration (optional)

### Infrastructure Performance
- **Instance Type**: Right-sized EC2 instances
- **Storage**: GP3 EBS volumes
- **Network**: VPC optimization
- **Monitoring**: CloudWatch metrics

## üåç Multi-Environment Support

### Environment Configuration
- **Production**: `production` environment
- **Staging**: `staging` environment
- **Development**: Local Docker Compose

### Environment Variables
Each environment can have different:
- Instance sizes
- Database configurations
- Domain names
- Security settings

### Deployment Strategies
- **Blue-Green**: Zero-downtime deployments
- **Rolling**: Gradual updates
- **Canary**: Traffic-split testing

## üìö Additional Resources

### Documentation
- [Terraform AWS Provider](https://registry.terraform.io/providers/hashicorp/aws/latest/docs)
- [Docker Compose Reference](https://docs.docker.com/compose/)
- [GitHub Actions Documentation](https://docs.github.com/en/actions)
- [Nix Package Manager](https://nixos.org/manual/nix/stable/)

### Support
- Check GitHub Issues for common problems
- Review deployment logs for error details
- Use the setup assistant for configuration help

## üîß Customization

### Infrastructure Customization
Edit `deploy/terraform/variables.tf` to modify:
- Instance types and sizes
- Network configuration
- Security group rules
- Backup settings

### Application Customization
Edit `docker-compose.yml` to modify:
- Environment variables
- Port mappings
- Volume mounts
- Service dependencies

### Monitoring Customization
Edit `deploy/nixos/ec2-configuration.nix` to modify:
- System monitoring
- Log rotation
- Security settings
- Performance tuning

---

## üéâ Congratulations!

You now have a fully automated, production-ready deployment pipeline for your Fantasy Football Draft Board application. The system provides:

- **One-button deployments** via GitHub Actions
- **Infrastructure as Code** with Terraform
- **Containerized applications** with Docker
- **Reproducible builds** with Nix
- **Security hardening** and monitoring
- **Automated backups** and maintenance

Enjoy your automated deployment pipeline! üöÄ